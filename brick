#!/usr/bin/env php
<?php

// 1. Definiamo la root del progetto
define('BRICK_PATH', __DIR__);

require BRICK_PATH . '/vendor/autoload.php';

// 2. Carica le variabili d'ambiente (.env)
if (file_exists(BRICK_PATH . '/.env')) {
    $dotenv = Dotenv\Dotenv::createImmutable(BRICK_PATH);
    $dotenv->load();
}

$command = $argv[1] ?? 'help';
$name = $argv[2] ?? null;

switch ($command) {
    case 'make:controller':
        createFile('Controller', $name, 'app/Controllers/Web');
        break;

    case 'make:model':
        createFile('Model', $name, 'app/Models');
        break;

    case 'migrate':
        runMigrations();
        break;

    case 'help':
    default:
        echo "\nüß± BrickPHP CLI Tool\n";
        echo "Usage: php brick [command] [name]\n\n";
        echo "Commands:\n";
        echo "  make:controller {Name}  Crea un Controller in app/Controllers/Web\n";
        echo "  make:model {Name}       Crea un Model in app/Models\n";
        echo "  migrate                 Esegue i file .sql in database/migrations/\n";
        echo "  cache:clear             Svuota la cache del filesystem\n\n";
        break;
}

function createFile($type, $name, $subDir) {
    if (!$name) die("‚ùå Errore: Specifica il nome del $type (es. User$type)\n");

    // Assicuriamoci che il nome inizi con la maiuscola
    $name = ucfirst($name);
    $fullPathDir = BRICK_PATH . "/{$subDir}";
    $filePath = "{$fullPathDir}/{$name}.php";

    // Crea la cartella se non esiste
    if (!is_dir($fullPathDir)) {
        mkdir($fullPathDir, 0755, true);
    }

    if (file_exists($filePath)) die("‚ö†Ô∏è Il $type {$name} esiste gi√†!\n");

    // Genera il Namespace in base alla cartella
    $namespace = str_replace(['app/', '/'], ['App\\', '\\'], $subDir);

    if ($type === 'Model') {
        $table = strtolower($name) . 's';
        $template = "<?php\n\nnamespace {$namespace};\n\nclass {$name}\n{\n    protected static \$table = '{$table}';\n\n    public static function all()\n    {\n        return db()->table(self::\$table)->get();\n    }\n}\n";
    } else {
        $template = "<?php\n\nnamespace {$namespace};\n\nuse BrickPHP\Core\Http\Request;\nuse BrickPHP\Core\Http\Response;\n\nclass {$name}\n{\n    public function index(Request \$request): Response\n    {\n        // return view('welcome');\n        return new Response('Nuovo Controller {$name} pronto!');\n    }\n}\n";
    }

    file_put_contents($filePath, $template);
    echo "‚úÖ $type creato correttamente: {$filePath}\n";
}

function runMigrations() {
    echo "üöÄ BrickPHP Migration Tool\n";
    echo "--------------------------\n";

    try {
        $config = require BRICK_PATH . '/config/database.php';
        $pdo = \BrickPHP\Database\Connection::make($config);

        $pdo->exec("CREATE TABLE IF NOT EXISTS migrations (
            id INT AUTO_INCREMENT PRIMARY KEY,
            migration VARCHAR(255),
            executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )");

        $files = glob(BRICK_PATH . '/database/migrations/*.sql');
        if (empty($files)) {
            echo "‚ÑπÔ∏è Nessuna migrazione trovata in database/migrations/\n";
            return;
        }

        sort($files);

        foreach ($files as $file) {
            $filename = basename($file);
            $stmt = $pdo->prepare("SELECT id FROM migrations WHERE migration = ?");
            $stmt->execute([$filename]);

            if ($stmt->fetch()) {
                echo "  ‚è© Salto: $filename (gi√† eseguita)\n";
                continue;
            }

            $sql = file_get_contents($file);
            $pdo->exec($sql);

            $stmt = $pdo->prepare("INSERT INTO migrations (migration) VALUES (?)");
            $stmt->execute([$filename]);

            echo "  ‚úÖ Eseguito: $filename\n";
        }
        echo "--------------------------\n‚ú® Migrazioni completate!\n";
    } catch (\Exception $e) {
        die("‚ùå Errore durante la migrazione: " . $e->getMessage() . "\n");
    }
}